<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Verve Juice Order</title>

    <!-- Tailwind & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&family=Inter:wght@400;700&family=Rubik+Bubbles&family=Noto+Sans+Thai:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans Thai', sans-serif;
            background: linear-gradient(135deg, #86efac, #fde047);
        }
        .cute-font { font-family: 'Kanit', sans-serif; }
        .container { max-width: 90%; margin-top: 1rem; margin-bottom: 1rem; }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06);
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        input[type="number"] { -moz-appearance: textfield; }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

<div class="container bg-white/30 backdrop-blur-xl p-6 rounded-3xl shadow-2xl w-full max-w-lg transition-all duration-300">

    <!-- Order Form Section -->
    <div id="order-form-section">
        <div class="flex justify-center mb-6">
            <img src="https://github.com/kornkawes/VerveImage/blob/main/logo2.png?raw=true"
                 alt="Verve Juice Logo" class="w-48" />
        </div>

        <!-- Social -->
        <div class="flex justify-center space-x-6 mb-6 text-2xl text-gray-800">
            <a href="https://www.tiktok.com/@vervejuice.th"
               class="hover:text-emerald-600" target="_blank" aria-label="TikTok">
                <i class="fa-brands fa-tiktok"></i>
            </a>
            <a href="https://www.instagram.com/vervejuice.th"
               class="hover:text-emerald-600" target="_blank" aria-label="Instagram">
                <i class="fa-brands fa-instagram"></i>
            </a>
        </div>

        <h2 class="text-2xl font-bold mb-4" style="color:#39531a;">เมนู</h2>
        <div id="menu-items" class="space-y-4"></div>
        <hr class="my-8 border-gray-300">

        <div class="mb-4">
            <label for="customerName" class="block text-gray-700 font-bold mb-2">
                ชื่อของคุณ*
            </label>
            <input id="customerName" type="text" placeholder="กรุณากรอกชื่อ-นามสกุล"
                   class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-300" />
        </div>

        <div class="mb-4">
            <label for="customerPhone" class="block text-gray-700 font-bold mb-2">
                ช่องทางการติดต่อ*
            </label>
            <input id="customerPhone" type="tel" placeholder="เบอร์โทรศัพท์ (10 หลัก)"
                   class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-300 mb-2" />
            <div class="flex space-x-2">
                <input id="contactApp" type="text" placeholder="Line,Instagram"
                       class="w-1/3 px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-300" />
                <input id="contactId" type="text" placeholder="@vervejuice (ไม่บังคับ)"
                       class="w-2/3 px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-300" />
            </div>
        </div>

        <div class="mb-4">
            <label for="customerNote" class="block text-gray-700 font-bold mb-2">หมายเหตุ</label>
            <textarea id="customerNote" placeholder="เช่น สะดวกรับวันไหน"
                      class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-300 resize-none h-24"></textarea>
        </div>

        <!-- Discount Section -->
        <div class="mt-6">
            <label for="discountCode" class="block text-gray-700 font-bold mb-2">โค้ดส่วนลด</label>
            <div class="flex space-x-2">
                <input id="discountCode" type="text" placeholder="กรอกโค้ดส่วนลด"
                       class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-300" />
                <button id="apply-discount-btn"
                        class="px-4 py-2 bg-gray-600 text-white font-bold rounded-xl hover:bg-gray-700 transition-colors">
                    ใช้
                </button>
            </div>
            <p id="discount-info" class="text-sm mt-2 h-5"></p>
        </div>

        <!-- Totals -->
        <div id="total-summary-section"
             class="mt-4 p-4 bg-emerald-100 rounded-2xl space-y-2">
            <div class="flex justify-between items-center text-gray-700">
                <span>ยอดรวม</span><span id="subtotal-price">฿0</span>
            </div>
            <div id="discount-display-section"
                 class="flex justify-between items-center text-red-500 hidden">
                <span>ส่วนลด (<span id="discount-code-display"></span>)</span>
                <span id="discount-amount">-฿0</span>
            </div>
            <div class="flex justify-between items-center text-gray-800 border-t pt-2 mt-2">
                <span class="text-lg font-bold">ยอดสุทธิ</span>
                <span id="total-price"
                      class="text-2xl font-extrabold text-emerald-600">฿0</span>
            </div>
        </div>

        <button id="confirm-order-btn"
                class="w-full mt-6 bg-emerald-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:bg-emerald-700 transition-colors">
            ยืนยันการสั่งซื้อ
        </button>
    </div>

    <!-- Payment Section -->
    <div id="payment-section" class="hidden">
        <h1 class="text-3xl font-bold text-center mb-2" style="color:#39531a;">ชำระเงิน</h1>
        <button id="back-to-menu-btn"
                class="mb-4 px-4 py-2 bg-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-300 transition-colors">
            ย้อนกลับ
        </button>

        <div id="order-summary" class="p-4 bg-gray-50 rounded-2xl mb-4">
            <h3 class="font-bold text-lg mb-2">สรุปรายการสั่งซื้อ:</h3>
        </div>

        <div class="p-4 bg-emerald-100 rounded-2xl text-center mb-6">
            <p class="text-xl font-bold text-emerald-700">ยอดที่ต้องชำระ</p>
            <p id="payment-total"
               class="text-4xl font-extrabold text-emerald-600 my-2">฿0</p>
        </div>

        <!-- QR & Bank -->
        <div class="space-y-4">
            <div class="bg-gray-50 p-4 rounded-2xl flex flex-col items-center">
                <p class="font-bold mb-2">โอนผ่าน QR Code</p>
                <div id="qr-display-container"
                     class="w-48 h-48 border border-gray-200 rounded-xl flex items-center justify-center bg-gray-100">
                    <img id="qrCodeImage"
                         src="https://github.com/kornkawes/Image/blob/main/unnamed%20(1).jpg?raw=true"
                         alt="QR Code"
                         class="w-full h-full object-contain rounded-xl"
                         onerror="this.onerror=null;this.src='https://placehold.co/400x400/eeeeee/333333?text=QR+Code';showMessageBox('ไม่สามารถโหลดรูปภาพได้','red');">
                </div>
                <p class="text-sm text-gray-500 mt-2">สแกนเพื่อชำระเงิน</p>
            </div>

            <div class="bg-gray-50 p-4 rounded-2xl">
                <p class="font-bold mb-1">หรือโอนผ่านบัญชีธนาคาร</p>
                <div class="bg-gray-100 p-3 rounded-xl flex items-center justify-between">
                    <div class="flex-1 text-sm">
                        <p>ชื่อบัญชี: นาย กรกวี สายเพชร</p>
                        <p>ธนาคาร: ธนาคารกสิกรไทย</p>
                        <p class="font-bold" id="bank-account-number">
                            เลขที่บัญชี: 014-1-08305-8
                        </p>
                    </div>
                    <button id="copy-account-btn"
                            class="ml-4 px-3 py-1 bg-gray-200 text-gray-700 text-sm font-bold rounded-lg hover:bg-gray-300 transition-colors">
                        คัดลอก
                    </button>
                </div>
            </div>
        </div>

        <div class="mt-6">
            <label for="slipUpload" class="block text-gray-700 font-bold mb-2">
                อัปโหลดสลิปการโอน
            </label>
            <input id="slipUpload" type="file" accept="image/*"
                   class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-300" />
        </div>

        <div id="slip-preview-container"
             class="hidden mt-4 p-4 border rounded-xl bg-gray-50 flex flex-col items-center">
            <p class="text-sm text-gray-600 mb-2">รูปสลิปที่เลือก:</p>
            <img id="slip-preview" src="#" alt="Slip Preview"
                 class="max-w-xs max-h-40 rounded-lg object-contain border border-gray-300" />
        </div>

        <button id="upload-slip-btn"
                class="w-full mt-6 bg-emerald-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:bg-emerald-700 transition-colors flex items-center justify-center">
            <span id="upload-slip-text">แจ้งโอนเงิน</span>
            <div id="upload-slip-spinner" class="spinner hidden ml-2"></div>
        </button>
    </div>

    <!-- Confirmation Section -->
    <div id="confirmation-section" class="hidden text-center">
        <svg class="mx-auto h-16 w-16 text-emerald-500" fill="none" stroke="currentColor"
             viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h1 class="text-3xl font-bold text-center mt-4 text-emerald-600 cute-font">
            ขอบคุณสำหรับคำสั่งซื้อ!
        </h1>
        <p class="mt-2 text-gray-600">
            หลังจากตรวจสอบสลิปแล้ว จะเริ่มจัดเตรียมคำสั่งซื้อให้ทันทีครับ
        </p>
        <p class="text-center text-red-600 text-xs mb-4">
            (กรุณาบันทึกภาพหน้าจอนี้ไว้เป็นหลักฐานคำสั่งซื้อ)
        </p>

        <div id="final-order-summary"
             class="mt-6 text-left p-4 bg-gray-50 rounded-2xl border border-emerald-200"></div>

        <button onclick="window.location.reload()"
                class="mt-6 bg-gray-400 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-gray-500 transition-colors">
            สั่งสินค้าเพิ่ม
        </button>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const menu = [
        { id: 'apple-kiss', name: 'Apple Kiss', price: 70, unit: 'ขวด (200ml)', ingredients: 'แอปเปิ้ลเขียว, ขิง, มะนาว', properties: 'ช่วยป้องกันผิวจากแสงแดด, ลดจุดด่างดำ, รอยสิว', imageUrl: 'https://github.com/kornkawes/VerveImage/blob/main/1.png?raw=true' },
        { id: 'blush-bloom', name: 'Blush Bloom', price: 70, unit: 'ขวด (200ml)', ingredients: 'มะเขือเทศ, สับปะรด, มะนาว', properties: 'ช่วยผลัดเซลล์ผิวเก่าและลดริ้วรอย', imageUrl: 'https://github.com/kornkawes/VerveImage/blob/main/2.png?raw=true' },
        { id: 'happy-tummy', name: 'Happy Tummy', price: 70, unit: 'ขวด (200ml)', ingredients: 'แอปเปิ้ล, กระชาย, ขิง, มะนาว', properties: 'ล้างสารพิษ, รักษาอาการท้องผูก, ท้องอืด, จุกเสียดแน่นท้อง', imageUrl: 'https://github.com/kornkawes/VerveImage/blob/main/3.png?raw=true' },
        { id: 'hearty-green', name: 'Hearty Green', price: 70, unit: 'ขวด (200ml)', ingredients: 'แอปเปิ้ล, สับปะรด, แตงกวา', properties: 'ลดคอเลสเตอรอลและต่อต้านมะเร็ง', imageUrl: 'https://github.com/kornkawes/VerveImage/blob/main/4.png?raw=true' },
        { id: 'sweet-detox', name: 'Sweet Detox', price: 70, unit: 'ขวด (200ml)', ingredients: 'แอปเปิ้ล, แครอท, บีทรูท', properties: 'ล้างสารพิษสำหรับคนควบคุมน้ำหนัก, ต้านสารอนุมูลอิสระ', imageUrl: 'https://github.com/kornkawes/VerveImage/blob/main/5.png?raw=true' },
        { id: 'beet-love', name: 'Beet Love', price: 70, unit: 'ขวด (200ml)', ingredients: 'แอปเปิ้ล, บีทรูท, มะนาว', properties: 'ดูแลสุขภาพหัวใจและควบคุมความดันโลหิต', imageUrl: 'https://github.com/kornkawes/VerveImage/blob/main/6.png?raw=true' },
        { id: 'smart-sip', name: 'Smart Sip', price: 70, unit: 'ขวด (200ml)', ingredients: 'แอปเปิ้ล, คะน้า, สับปะรด', properties: 'ช่วยบำรุงการทำงานของสมองและบำรุงสายตา', imageUrl: 'https://github.com/kornkawes/VerveImage/blob/main/7.png?raw=true' },
        { id: 'recharge-me', name: 'Recharge Me', price: 70, unit: 'ขวด (200ml)', ingredients: 'แอปเปิ้ล, ขิง, มะนาว', properties: 'กระตุ้นร่างกายให้ฟื้นตัวจากการเมื่อยล้า', imageUrl: 'https://github.com/kornkawes/VerveImage/blob/main/8.png?raw=true' }
    ];

    const discountCodes = [
        { code:"SUCHATANDSOMPOP", type:"percent", value:15,
          expiryDate:"2025-12-31", minSpend:0, minItems:5 },
        { code:"VERVETIKTOK", type:"percent", value:10,
          expiryDate:"2025-10-15", minSpend:0, minItems:3 }
    ];

    const n8nWebhookUrl = "https://verve2.app.n8n.cloud/webhook/3292a5c3-0f7f-424f-92f8-7dc42f51d763";

    // Elements
    const menuItemsEl = document.getElementById('menu-items');
    const confirmOrderBtn = document.getElementById('confirm-order-btn');
    const orderFormSection = document.getElementById('order-form-section');
    const paymentSection = document.getElementById('payment-section');
    const confirmationSection = document.getElementById('confirmation-section');
    const slipUploadEl = document.getElementById('slipUpload');
    const customerNameEl = document.getElementById('customerName');
    const customerPhoneEl = document.getElementById('customerPhone');
    const contactAppEl = document.getElementById('contactApp');
    const contactIdEl = document.getElementById('contactId');
    const customerNoteEl = document.getElementById('customerNote');
    const copyAccountBtn = document.getElementById('copy-account-btn');
    const slipPreviewContainerEl = document.getElementById('slip-preview-container');
    const slipPreviewEl = document.getElementById('slip-preview');
    const uploadSlipBtn = document.getElementById('upload-slip-btn');
    const backToMenuBtn = document.getElementById('back-to-menu-btn');
    const uploadSlipTextEl = document.getElementById('upload-slip-text');
    const uploadSlipSpinnerEl = document.getElementById('upload-slip-spinner');
    const finalOrderSummaryEl = document.getElementById('final-order-summary');
    const orderSummaryEl = document.getElementById('order-summary');
    const paymentTotalEl = document.getElementById('payment-total');
    const subtotalPriceEl = document.getElementById('subtotal-price');
    const discountAmountEl = document.getElementById('discount-amount');
    const totalPriceEl = document.getElementById('total-price');
    const discountDisplaySectionEl = document.getElementById('discount-display-section');
    const discountCodeDisplayEl = document.getElementById('discount-code-display');
    const discountCodeInputEl = document.getElementById('discountCode');
    const applyDiscountBtnEl = document.getElementById('apply-discount-btn');
    const discountInfoEl = document.getElementById('discount-info');

    let order = { items:{}, total:0, subtotal:0, discount:null, totalItems:0 };

    window.showMessageBox = (message, color) => {
        const colorMap = { red:'bg-red-500', green:'bg-green-500' };
        const box = document.createElement('div');
        box.className = `fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 ${colorMap[color] || 'bg-gray-500'} text-white px-6 py-4 rounded-xl shadow-lg z-50 transition-all duration-300`;
        box.textContent = message;
        document.body.appendChild(box);
        setTimeout(() => box.remove(), 3000);
    };

    const getOrderQueueNumber = () => {
        const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result='';
        for(let i=0;i<3;i++) result+=chars.charAt(Math.floor(Math.random()*chars.length));
        return result;
    };

    async function fetchWithRetry(url, options, retries=3, delay=1000) {
        for(let i=0;i<retries;i++){
            try {
                const res = await fetch(url, options);
                if(res.ok) return res;
                if(res.status===429||res.status>=500){
                    await new Promise(r=>setTimeout(r, delay*Math.pow(2,i)));
                } else { throw new Error(`HTTP error! status: ${res.status}`); }
            } catch(e){
                if(i<retries-1){
                    await new Promise(r=>setTimeout(r, delay*Math.pow(2,i)));
                } else { throw e; }
            }
        }
    }

    window.toggleAllergyInput = checkbox => {
        const id = checkbox.dataset.id;
        const div = document.getElementById(`allergy-input-${id}`);
        if(checkbox.checked){
            div.classList.remove('hidden');
        } else {
            div.classList.add('hidden');
            const input = div.querySelector('input');
            input.value = '';
            if(order.items[id]) order.items[id].allergyNote = '';
        }
    };

    window.updateAllergyNote = input => {
        const id = input.dataset.id;
        const note = input.value.trim();
        if(order.items[id]) {
            order.items[id].allergyNote = note;
            if(!note){
                const checkbox = document.querySelector(`input[type="checkbox"][data-id="${id}"]`);
                checkbox.checked = false;
                document.getElementById(`allergy-input-${id}`).classList.add('hidden');
            }
        }
    };

    const updateTotal = () => {
        let subtotal=0, totalItems=0;
        for(const id in order.items){
            const itm = order.items[id];
            if(itm.quantity>0){
                subtotal += itm.price * itm.quantity;
                totalItems += itm.quantity;
            }
        }
        order.subtotal = subtotal;
        order.totalItems = totalItems;

        if(order.discount){
            const {minSpend,minItems} = order.discount;
            if(subtotal < minSpend || totalItems < minItems){
                order.discount = null;
                discountInfoEl.textContent = '';
            }
        }

        let discountValue = 0;
        if(order.discount){
            discountValue = order.discount.type === 'fixed'
                ? order.discount.value
                : (subtotal * order.discount.value) / 100;
        }
        let total = Math.max(subtotal - discountValue, 0);
        order.total = total;

        subtotalPriceEl.textContent = `฿${subtotal}`;
        if(order.discount){
            discountAmountEl.textContent = `-฿${discountValue.toFixed(2)}`;
            discountCodeDisplayEl.textContent = order.discount.code;
            discountDisplaySectionEl.classList.remove('hidden');
        } else {
            discountDisplaySectionEl.classList.add('hidden');
        }
        totalPriceEl.textContent = `฿${total.toFixed(2)}`;
    };

    const renderMenu = () => {
        menuItemsEl.innerHTML = '';
        menu.forEach(item => {
            const quantity = order.items[item.id]?.quantity || 0;
            const itemHtml = `
                <div class="p-4 bg-gray-50 rounded-xl card flex items-center space-x-4">
                    <img src="${item.imageUrl}" alt="${item.name}"
                         class="w-32 h-32 rounded-lg object-cover flex-shrink-0">
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex-1">
                                <h3 class="font-bold text-gray-800">${item.name}</h3>
                                <p class="text-sm text-gray-500"><span class="font-bold">ราคา:</span> ฿${item.price} ต่อ ${item.unit}</p>
                                <p class="text-xs text-gray-400 mt-1"><span class="font-bold">ส่วนผสม:</span> ${item.ingredients}</p>
                                <p class="text-xs text-gray-400 mt-1"><span class="font-bold">สรรพคุณ:</span> ${item.properties}</p>
                            </div>
                        </div>

                        <div class="mt-2 text-sm text-gray-700">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" class="form-checkbox h-4 w-4 text-emerald-600 rounded"
                                       data-id="${item.id}" onchange="toggleAllergyInput(this)">
                                <span>แจ้งส่วนผสมที่แพ้ (ถ้ามี)</span>
                            </label>
                            <div id="allergy-input-${item.id}" class="mt-2 hidden">
                                <input type="text" data-id="${item.id}" oninput="updateAllergyNote(this)"
                                       placeholder="เช่น แพ้มะม่วง"
                                       class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-1 focus:ring-emerald-500" />
                                <p class="mt-1 text-xs text-red-500">
                                    หมายเหตุ: รสชาติอาจแตกต่างจากสูตรปกติเนื่องจากมีการปรับเปลี่ยนส่วนผสม
                                </p>
                            </div>
                        </div>

                        <div class="flex items-center justify-center space-x-2 mt-4">
                            <button data-id="${item.id}" data-action="minus"
                                    class="w-8 h-8 flex items-center justify-center rounded-full text-white text-lg font-bold bg-emerald-400 hover:bg-emerald-500 transition-colors">-</button>
                            <input type="number" data-id="${item.id}"
                                   class="w-12 text-center border-none bg-transparent font-bold focus:outline-none"
                                   value="${quantity}" min="0" readonly />
                            <button data-id="${item.id}" data-action="plus"
                                    class="w-8 h-8 flex items-center justify-center rounded-full text-white text-lg font-bold bg-emerald-600 hover:bg-emerald-700 transition-colors">+</button>
                        </div>
                    </div>
                </div>`;
            menuItemsEl.insertAdjacentHTML('beforeend', itemHtml);

            if(order.items[item.id]?.allergyNote){
                const checkbox = menuItemsEl.querySelector(`input[type="checkbox"][data-id="${item.id}"]`);
                const allergyDiv = document.getElementById(`allergy-input-${item.id}`);
                checkbox.checked = true;
                allergyDiv.classList.remove('hidden');
                allergyDiv.querySelector('input').value = order.items[item.id].allergyNote;
            }
        });
    };

    menuItemsEl.addEventListener('click', e => {
        const button = e.target.closest('button');
        if(!button || !button.dataset.action) return;

        const id = button.dataset.id;
        if(!order.items[id]){
            const src = menu.find(i => i.id === id);
            order.items[id] = { ...src, quantity:0, allergyNote:'' };
        }

        if(button.dataset.action === 'plus') order.items[id].quantity++;
        else if(button.dataset.action === 'minus' && order.items[id].quantity > 0)
            order.items[id].quantity--;

        if(order.items[id].quantity === 0 && !order.items[id].allergyNote) delete order.items[id];

        const inputEl = menuItemsEl.querySelector(`input[data-id="${id}"][type="number"]`);
        if(inputEl) inputEl.value = order.items[id]?.quantity || 0;

        updateTotal();
    });

    applyDiscountBtnEl.addEventListener('click', () => {
        const code = discountCodeInputEl.value.trim().toUpperCase();
        if(!code){
            order.discount = null;
            discountInfoEl.textContent = '';
            updateTotal();
            return;
        }
        const found = discountCodes.find(c => c.code === code);
        if(!found){
            order.discount = null;
            discountInfoEl.textContent = 'โค้ดส่วนลดไม่ถูกต้อง';
            discountInfoEl.className = 'text-sm mt-2 h-5 text-red-500';
            updateTotal();
            return;
        }
        const today = new Date(); today.setHours(0,0,0,0);
        const expiry = new Date(found.expiryDate); expiry.setHours(23,59,59,999);
        if(today > expiry){
            order.discount = null;
            discountInfoEl.textContent = 'โค้ดนี้หมดอายุแล้ว';
            discountInfoEl.className = 'text-sm mt-2 h-5 text-red-500';
            updateTotal();
            return;
        }
        if(order.subtotal < found.minSpend){
            order.discount = null;
            discountInfoEl.textContent = `ต้องมียอดสั่งซื้อขั้นต่ำ ฿${found.minSpend}`;
            discountInfoEl.className = 'text-sm mt-2 h-5 text-red-500';
            updateTotal();
            return;
        }
        if(order.totalItems < found.minItems){
            order.discount = null;
            discountInfoEl.textContent = `ต้องสั่งซื้อขั้นต่ำ ${found.minItems} ขวด`;
            discountInfoEl.className = 'text-sm mt-2 h-5 text-red-500';
            updateTotal();
            return;
        }
        order.discount = found;
        discountInfoEl.textContent = 'ใช้โค้ดส่วนลดสำเร็จ!';
        discountInfoEl.className = 'text-sm mt-2 h-5 text-green-600';
        updateTotal();
    });

    const renderOrderSummary = (container, data, includeTotal) => {
        container.innerHTML = '';
        const displayDate = new Date(data.orderDate).toLocaleString('th-TH',{
            year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit',
            timeZone:'Asia/Bangkok'
        });

        const fields = [
            ['Order ID', data.queueNumber],
            ['วันที่สั่ง', displayDate],
            ['ชื่อลูกค้า', data.customerName],
            ['ช่องทางการติดต่อ', data.customerContact.phone]
        ];
        if(data.customerContact.other) fields.push(['ช่องทางติดต่ออื่น', data.customerContact.other]);
        if(data.customerNote) fields.push(['หมายเหตุ', data.customerNote]);

        fields.forEach(([label,value],idx)=>{
            const p = document.createElement('p');
            p.className = `text-sm font-bold text-gray-700${idx===0?'':' mt-2'}`;
            p.textContent = `${label}: ${value}`;
            container.appendChild(p);
        });

        const listDiv = document.createElement('div');
        listDiv.className = 'mt-4';
        const h4 = document.createElement('h4');
        h4.className = 'font-bold';
        h4.textContent = 'รายการสั่งซื้อ:';
        listDiv.appendChild(h4);
        data.items.forEach(item=>{
            const p = document.createElement('p');
            p.className = 'text-sm text-gray-600';
            p.textContent = `${item.name} x ${item.quantity} ${item.unit} (฿${item.price * item.quantity})`;
            listDiv.appendChild(p);
            if(item.allergyNote){
                const ap = document.createElement('p');
                ap.className = 'ml-4 text-xs text-red-500';
                ap.textContent = `หมายเหตุแพ้อาหาร: ${item.allergyNote}`;
                listDiv.appendChild(ap);
            }
        });
        container.appendChild(listDiv);

        const totalsDiv = document.createElement('div');
        totalsDiv.className = 'mt-2 pt-2 border-t';
        const subP = document.createElement('p');
        subP.className = 'text-sm text-right text-gray-600';
        subP.textContent = `ยอดรวม: ฿${data.subtotal.toFixed(2)}`;
        totalsDiv.appendChild(subP);

        if(data.discount){
            const discountAmount = data.discount.type === 'fixed'
                ? data.discount.value
                : (data.subtotal * data.discount.value) / 100;
            const discP = document.createElement('p');
            discP.className = 'text-sm text-right text-red-500';
            discP.textContent = `ส่วนลด (${data.discount.code}): -฿${discountAmount.toFixed(2)}`;
            totalsDiv.appendChild(discP);
        }

        if(includeTotal){
            const totalDiv = document.createElement('div');
            totalDiv.className = 'flex justify-between items-center mt-1';
            const label = document.createElement('span');
            label.className = 'font-bold text-gray-800';
            label.textContent = 'ยอดสุทธิ:';
            const value = document.createElement('span');
            value.className = 'text-xl font-extrabold text-emerald-600';
            value.textContent = `฿${data.total.toFixed(2)}`;
            totalDiv.append(label,value);
            totalsDiv.appendChild(totalDiv);
        }
        container.appendChild(totalsDiv);
    };

    confirmOrderBtn.addEventListener('click', () => {
        const name = customerNameEl.value.trim();
        const phone = customerPhoneEl.value.trim();
        const app = contactAppEl.value.trim();
        const appId = contactIdEl.value.trim();
        const note = customerNoteEl.value.trim();

        if(!name) return showMessageBox('กรุณากรอกชื่อให้ครบถ้วน','red');
        if(!/^\d{10}$/.test(phone)) return showMessageBox('กรุณากรอกเบอร์โทรศัพท์ให้ถูกต้อง (10 หลัก)','red');
        if(Object.keys(order.items).length===0) return showMessageBox('กรุณาเลือกเมนูอย่างน้อย 1 รายการ','red');

        const finalOrder = {
            queueNumber: getOrderQueueNumber(),
            customerName: name,
            customerContact: {
                phone: phone,
                other: app && appId ? `${app}: ${appId}` : ''
            },
            customerNote: note,
            orderDate: new Date().toISOString(),
            items: Object.values(order.items).filter(i=>i.quantity>0),
            subtotal: order.subtotal,
            discount: order.discount,
            total: order.total,
            totalItems: order.totalItems
        };

        localStorage.setItem('currentOrder', JSON.stringify(finalOrder));
        renderOrderSummary(orderSummaryEl, finalOrder, false);
        paymentTotalEl.textContent = `฿${finalOrder.total.toFixed(2)}`;
        orderFormSection.classList.add('hidden');
        paymentSection.classList.remove('hidden');
    });

    backToMenuBtn.addEventListener('click', () => {
        paymentSection.classList.add('hidden');
        orderFormSection.classList.remove('hidden');
    });

    slipUploadEl.addEventListener('change', e => {
        const file = e.target.files[0];
        if(file){
            const reader = new FileReader();
            reader.onload = evt => {
                slipPreviewEl.src = evt.target.result;
                slipPreviewContainerEl.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        } else {
            slipPreviewContainerEl.classList.add('hidden');
            slipPreviewEl.src = '#';
        }
    });

    copyAccountBtn.addEventListener('click', () => {
        const account = document.getElementById('bank-account-number').textContent.split(': ')[1];
        navigator.clipboard.writeText(account).then(()=>{
            showMessageBox('คัดลอกเลขบัญชีแล้ว!','green');
        },()=>{ showMessageBox('คัดลอกไม่สำเร็จ','red'); });
    });

    uploadSlipBtn.addEventListener('click', async () => {
        const slipFile = slipUploadEl.files[0];
        if(!slipFile) return showMessageBox('กรุณาอัปโหลดสลิปการโอนเงิน','red');

        uploadSlipBtn.disabled = true;
        uploadSlipTextEl.classList.add('hidden');
        uploadSlipSpinnerEl.classList.remove('hidden');

        const currentOrder = JSON.parse(localStorage.getItem('currentOrder'));
        const formData = new FormData();
        formData.append('slipImage', slipFile);
        formData.append('queueNumber', currentOrder.queueNumber);
        formData.append('customerName', currentOrder.customerName);
        formData.append('customerNote', currentOrder.customerNote);
        formData.append('subtotal', currentOrder.subtotal);
        formData.append('total', currentOrder.total);
        formData.append('discount', currentOrder.discount ? JSON.stringify(currentOrder.discount) : '');
        formData.append('orderDate', currentOrder.orderDate);
        formData.append('customerPhone', currentOrder.customerContact.phone);
        formData.append('customerContactOther', currentOrder.customerContact.other);
        formData.append('items', JSON.stringify(currentOrder.items));

        try {
            await fetchWithRetry(n8nWebhookUrl, { method:'POST', body:formData });
            paymentSection.classList.add('hidden');
            confirmationSection.classList.remove('hidden');
            renderOrderSummary(finalOrderSummaryEl, currentOrder, true);
        } catch(err){
            console.error('Error sending data:', err);
            showMessageBox('เกิดข้อผิดพลาดในการส่งข้อมูล','red');
        } finally {
            uploadSlipBtn.disabled = false;
            uploadSlipTextEl.classList.remove('hidden');
            uploadSlipSpinnerEl.classList.add('hidden');
        }
    });

    renderMenu();
    updateTotal();
});
</script>
</body>
</html>

